<script setup>
  import BsAtUl from '@/components/input/BsAtUl.vue';
  import { ref,reactive } from 'vue';

  defineProps(['placeholder'])
  const contentDom = ref(null)

  //#region 表情包
  let rangeOfContentBox = ref('')
  /* 处理光标 */
  // document.onselectionchange= () => {
  //   let selection = document.getSelection()
  //   if(selection.rangeCount > 0) {
  //     const range = selection.getRangeAt(0)
  //     if(contentDom.value.contains(range.commonAncestorContainer)) {
  //       rangeOfContentBox = range
  //     }
  //   }
  // }
  /* 插入表情包 */
  function insertEmoji(emojiUrl) {
    // if(contentNum.value + 3 > 300) return ElMessage.error('字数已达上限')
    const emojiImg = document.createElement('img')
    emojiImg.src = emojiUrl
    if(!rangeOfContentBox.value) {
      rangeOfContentBox.value = new Range()
      rangeOfContentBox.value.selectNodeContents(contentDom.value)
      rangeOfContentBox.value.collapse(false)
    }
    if(rangeOfContentBox.value.collapsed) {
      rangeOfContentBox.value.insertNode(emojiImg)
    } else {
      rangeOfContentBox.value.deleteContents()
      rangeOfContentBox.value.insertNode(emojiImg)
    }
    rangeOfContentBox.value.collapse(false)
    contentNum.value += 3
  }
  /* 处理点击表情包光标移到表情包前 */
  function handleContentBoxClick(event) {
    setCaretForEmoji(event.target)
  }
  function setCaretForEmoji(target) {
    if(target.tagName === 'IMG') {
      let range = new Range()
      range.setStartBefore(target)
      range.collapse(true)
      document.getSelection().removeAllRanges()
      document.getSelection().addRange(range)
    }
  }
  //#endregion
  //#region 监听content
  const contentNum = ref(0)
  function handleContentNum() {
    // 判断innerHtml的<数量
    let htmlStr = contentDom.value.innerHTML.replace(/<div>|<br>|<\/div>|<\/span>/g,'')
    htmlStr = htmlStr.replace(/<span.*?>/g,'')
    let htmlArr = htmlStr.split('')
    /* 表情包数量 */
    const htmlLtCount = htmlArr.reduce((prev,cur)=>{
      return cur === '<' ? prev + 1 : prev
    },0)
    let textArr = contentDom.value.innerText.split('')
    /* < 和 > 数量 */
    const textLtCount = textArr.reduce((prev, cur)=>{
      return cur === '<' || cur === '>' ? prev + 1 : prev
    }, 0)
    return textArr.length + textLtCount*3 + htmlLtCount * 3
  }
  function changePubContent(event) {
    if(event.target.innerHTML === '<br>') {
      event.target.innerText = ''
    }
    /* 监听@输入 */
    if(event.data === '@') {
      setTimeout(() => {
        showAtSelect.value = true
        const {left, top} = getCursorPosition()
        atSelectPosition.left = left + 'px'
        atSelectPosition.top = top + 20 + 'px'
      }, 200);
    } else {
      showAtSelect.value = false
    }
    // if(handleContentNum() > 300) {
    //   const overTextNum = handleContentNum() - 300
    //   event.target.innerHTML = event.target.innerHTML.slice(0, event.target.innerHTML.length - overTextNum)
    //   ElMessage.error('字数已达上限！')
    //   event.target.blur()
    // }
    contentNum.value = handleContentNum()
  }
  function handleContentBlur() {
    setTimeout(() => {
      showAtSelect.value = false
    }, 200);
    if (window.getSelection) {
      let sel = window.getSelection();
      if (sel.getRangeAt && sel.rangeCount) {
        focusNode = sel.focusNode;
        focusOffset.value = sel.focusOffset;
        chatInputOffset = sel.getRangeAt(0);
      }
    }
  }
  //#endregion
  //#region @艾特功能
  let focusNode = reactive({}); // 存储光标聚焦节点
  let focusOffset = ref(0); // 存储光标聚焦偏移量
  let chatInputOffset = reactive({}); // 存储光标聚焦的元素
  const showAtSelect = ref(false)
  const atSelectPosition = reactive({
    left:"0px",
    top:"0px",
  })
  function getCursorPosition() {
    let selection = document.getSelection()
    let range = new Range()
    range.selectNode(selection.focusNode)
    range.setStart(selection.focusNode, selection.focusOffset)
    let {left, top} = range.getBoundingClientRect()
    left -= contentDom.value.getBoundingClientRect().left
    top -= contentDom.value.getBoundingClientRect().top
    return {left, top}
  }
  function handleClickAt() {
    // if(contentNum.value + 1 > 300) return ElMessage.error('字数已达上限')
    contentNum.value++
    const atElement = '@'
    if(!rangeOfContentBox.value) {
      rangeOfContentBox.value = new Range()
      rangeOfContentBox.value.selectNodeContents(contentDom.value)
      rangeOfContentBox.value.collapse(false)
    }
    const atNode = rangeOfContentBox.value.createContextualFragment(atElement)
    if(rangeOfContentBox.value.collapsed) {
      rangeOfContentBox.value.insertNode(atNode)
    } else {
      rangeOfContentBox.value.deleteContents()
      rangeOfContentBox.value.insertNode(atNode)
    }
    let {left, top} = rangeOfContentBox.value.getBoundingClientRect()
    left -= contentDom.value.getBoundingClientRect().left-14
    top -= contentDom.value.getBoundingClientRect().top-20
    atSelectPosition.left = left + 'px'
    atSelectPosition.top = top + 'px'
    rangeOfContentBox.value.collapse(false)
    document.getSelection().removeAllRanges()
    document.getSelection().addRange(rangeOfContentBox.value)
    setTimeout(() => {
      showAtSelect.value = true
    }, 200);
  }
  function selectAtUser(username) {
    // if(handleContentNum() + username.length + 1 > 300) return ElMessage.error('字数已达上限')
    showAtSelect.value = false
    chatInputOffset.setStart(focusNode,focusOffset.value-1)
    chatInputOffset.setEnd(focusNode,focusOffset.value)
    chatInputOffset.deleteContents()
    const atElement = `<span class="username" contenteditable="false">@${username}</span>`
    chatInputOffset.collapse(false)
    const atNode = chatInputOffset.createContextualFragment(atElement)
    let lastChild = atNode.lastChild
    chatInputOffset.insertNode(atNode)
    chatInputOffset.setEndAfter(lastChild)
    chatInputOffset.setStartAfter(lastChild)
    const selection = document.getSelection()
    selection.removeAllRanges()
    selection.addRange(chatInputOffset)
    contentNum.value = handleContentNum()
  }
  // const followerList = [
  //   {
  //     avatarUrl:'/imgs/default-avatar.png',
  //     username:'周权',
  //     fanNumInfo:111
  //   },
  //   {
  //     avatarUrl:'/imgs/default-avatar.png',
  //     username:'周权',
  //     fanNumInfo:111
  //   },
  //   {
  //     avatarUrl:'/imgs/default-avatar.png',
  //     username:'周权',
  //     fanNumInfo:111
  //   },
  //   {
  //     avatarUrl:'/imgs/default-avatar.png',
  //     username:'周权',
  //     fanNumInfo:111
  //   },
  // ]
  //#endregion
  /* 暴露方法 */
  defineExpose({
    insertEmoji,
    handleClickAt,
    selectAtUser,
    handleContentNum,
    contentNum,
    contentDom,
    rangeOfContentBox
  })
</script>

<template>
  <div class="bs-input-box">
    <div 
      ref="contentDom"
      contenteditable="true"
      @blur="handleContentBlur"
      @click="handleContentBoxClick"
      @input="changePubContent"
      :class="{'input-empty':!contentNum}"
      class="bs-rich-text-input"
      :placeholder="placeholder"
      tabindex="0"
    >
    </div>
    <bs-at-ul 
      v-if="showAtSelect" 
      @selectAtUser="selectAtUser" 
      :atSelectPosition="atSelectPosition"
    >
    </bs-at-ul>
  </div>
</template>

<style lang="scss">
  @use '@/assets/sass/config.scss' as *;
  .bs-input-box {
    position: relative;
    .bs-rich-text-input {
      position: relative;
      padding-top: 5px;
      width: 100%;
      font-size: $fontJ;
      img {
        width: 20px;
        height: 20px;
        vertical-align: middle;
      }
      .username {
        color: $colorM;
      }
    }
    .input-empty {
      &::after {
        content: attr(placeholder);
        position: absolute;
        top: 5px;
        color: $colorD;
        cursor: text;
      }
    }
  }
</style>